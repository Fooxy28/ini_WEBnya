<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Task & Schedule Management</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="user-profile">
                <div class="avatar">
                    <img src="https://ui-avatars.com/api/?name=Cat+Nip&background=random" alt="Avatar" class="w-100-h-100-rounded">
                </div>
                <div class="user-info">
                    <span class="greeting">Hello!</span>
                    <span class="username">Cat Nip</span>
                </div>
            </div>
            <div class="notification-icon">
                üîî
                <div class="notification-dot"></div>
            </div>
        </header>

        <!-- Progress Overview -->
        <section class="progress-overview">
            <div class="daily-progress-card">
                <div class="progress-circle">
                    <span class="progress-text" id="dailyProgressText">0%</span>
                </div>
                <div class="daily-info">
                    <h4>Progress Tugas<br>Hari Ini</h4>
                    <a href="task/taskmenu.html" class="btn-light">Tampilkan Tugas</a>
                </div>
            </div>
            
            <div class="flex-grow column-layout">
                <div class="in-progress-header clickable" onclick="window.location.href='task/taskmenu.html'">
                    <h4>In Progress</h4>
                    <span class="badge-nearest">Nearest Due</span>
                </div>
                <div class="horizontal-scroll" id="inProgressList">
                    <!-- In Progress Items will be injected here -->
                    <p class="text-muted in-progress-loading">Memuat...</p>
                </div>
            </div>
        </section>

        <!-- Task Groups -->
        <section class="task-groups horizontal-scroll" id="taskGroupsList">
            <!-- Task Groups will be injected here -->
            <p class="text-muted">Memuat grup...</p>
        </section>

        <!-- Calendar Strip -->
        <section class="calendar-strip">
            <h3>My Schedule's</h3>
            <div id="calendarStrip" class="calendar-dates">
                <!-- Generated by JS -->
            </div>
        </section>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Jadwal Column -->
            <section class="schedule-column">
                <div class="section-header">
                    <div class="flex-center-gap">
                        <span class="font-1-5">üìÖ</span>
                        <h3>Jadwal</h3>
                    </div>
                    <a href="schedule/addschedule.html" class="add-btn">+</a>
                </div>
                <div id="scheduleList" class="schedule-list">
                    <!-- Schedule items injected here -->
                    <p class="text-muted">Memuat jadwal...</p>
                </div>
            </section>

            <!-- Tugas Column -->
            <section class="tasks-column">
                <div class="section-header">
                    <div class="flex-center-gap">
                        <span class="font-1-5">+</span>
                        <h3>Tugas <small class="text-muted text-small-normal">My Task's</small></h3>
                    </div>
                    <a href="task/addtask.html" class="add-btn">+</a>
                </div>
                
                <div class="task-filters">
                    <button class="filter-btn active" onclick="renderTasks('Semua')">Semua</button>
                    <button class="filter-btn" onclick="renderTasks('Todo')">Todo</button>
                    <button class="filter-btn" onclick="renderTasks('On Progress')">On Progres</button>
                    <button class="filter-btn" onclick="renderTasks('Selesai')">Selesai</button>
                </div>

                <div id="taskList" class="task-list">
                    <!-- Task items injected here -->
                    <p class="text-muted">Memuat tugas...</p>
                </div>
            </section>
        </div>
    </div>

    <script src="../script.js"></script>
    <script>
        // Check Auth
        checkAuth();

        // Global State for Calendar
        let savedDate = sessionStorage.getItem('selectedCalendarDate');
        let selectedDate = savedDate ? new Date(savedDate) : new Date();

        // Render Calendar
        function renderCalendar() {
            const container = document.getElementById('calendarStrip');
            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            // Use selectedDate to determine the month to render
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '';
            
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                const dayName = days[date.getDay()];
                const dayNum = i;
                
                const isSelected = (
                    date.getDate() === selectedDate.getDate() && 
                    date.getMonth() === selectedDate.getMonth() &&
                    date.getFullYear() === selectedDate.getFullYear()
                );
                
                const activeClass = isSelected ? 'active' : '';
                
                html += `
                    <div class="date-item ${activeClass}" onclick="selectDate('${date.toISOString()}')">
                        <span class="date-num">${dayNum}</span>
                        <span class="date-day">${dayName}</span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function selectDate(dateStr) {
            selectedDate = new Date(dateStr);
            sessionStorage.setItem('selectedCalendarDate', dateStr); // Save selected date
            renderCalendar();
            renderSchedules();
        }

        // Enable Mouse Wheel Scroll
        const calendarContainer = document.getElementById('calendarStrip');
        if(calendarContainer) {
            calendarContainer.addEventListener('wheel', (evt) => {
                if (evt.deltaY !== 0) {
                    evt.preventDefault();
                    calendarContainer.scrollLeft += evt.deltaY;
                }
            });
        }

        renderCalendar();

        // --- Data Fetching ---
        const tasks = getTasks();
        const schedules = getSchedules();

        // --- Render Progress Overview ---
        function renderProgressOverview() {
            // Calculate average progress
            const totalProgress = tasks.reduce((acc, curr) => acc + (parseInt(curr.progress) || 0), 0);
            const avgProgress = tasks.length ? Math.round(totalProgress / tasks.length) : 0;
            
            const dailyText = document.getElementById('dailyProgressText');
            if(dailyText) dailyText.innerText = `${avgProgress}%`;

            // Update Big Circle Visual
            const progressCircle = document.querySelector('.progress-circle');
            if(progressCircle) {
                progressCircle.style.background = `conic-gradient(#fff ${avgProgress}%, rgba(255,255,255,0.3) 0)`;
            }

            // Render "In Progress" List (Nearest Due Tasks)
            // User requested: "task yang due nya paling dekat"
            const nearestTasks = tasks
                .filter(t => t.status !== 'done')
                .sort((a, b) => new Date(a.end) - new Date(b.end))
                .slice(0, 5); // Show top 5

            const inProgressListEl = document.getElementById('inProgressList');
            
            if (inProgressListEl) {
                if (nearestTasks.length === 0) {
                    inProgressListEl.innerHTML = '<p class="text-muted" style="padding:10px;">Tidak ada tugas aktif.</p>';
                } else {
                    inProgressListEl.innerHTML = nearestTasks.map((task, index) => {
                        const colors = ['bg-pink', 'bg-green', 'bg-purple', 'bg-orange'];
                        const colorClass = colors[index % colors.length];
                        
                        return `
                        <div class="card-item ${colorClass}">
                            <div class="card-icon bg-white">üìù</div>
                            <div class="card-content">
                                <small>${task.group || 'General'}</small>
                                <h5>${task.name}</h5>
                                <div class="progress-bar-container">
                                    <div class="progress-bar bg-white" style="width: ${task.progress}%"></div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            }
        }
        renderProgressOverview();

        // --- Render Task Groups ---
        function renderTaskGroups() {
            const groups = {};
            tasks.forEach(task => {
                const g = task.group || 'Lainnya';
                if (!groups[g]) groups[g] = { count: 0, totalProgress: 0 };
                groups[g].count++;
                groups[g].totalProgress += (parseInt(task.progress) || 0);
            });

            const taskGroupsListEl = document.getElementById('taskGroupsList');
            if (taskGroupsListEl) {
                const groupKeys = Object.keys(groups);

                if (groupKeys.length === 0) {
                    taskGroupsListEl.innerHTML = '<p class="text-muted">Belum ada grup.</p>';
                } else {
                    taskGroupsListEl.innerHTML = groupKeys.map((groupName, index) => {
                        const group = groups[groupName];
                        const avg = Math.round(group.totalProgress / group.count);
                        
                        const colors = ['bg-pink', 'bg-purple', 'bg-green', 'bg-orange'];
                        const colorClass = colors[index % colors.length];
                        // Simple color mapping for border/chart
                        let chartColor = '#ff6b6b';
                        if(colorClass === 'bg-purple') chartColor = '#6c5ce7';
                        if(colorClass === 'bg-green') chartColor = '#00b894';
                        if(colorClass === 'bg-orange') chartColor = '#fdcb6e';

                        return `
                        <div class="group-card" onclick="window.location.href='task/taskmenu.html?group=${encodeURIComponent(groupName)}'" style="cursor:pointer;">
                            <div class="card-icon ${colorClass}">üìÅ</div>
                            <div>
                                <h5>${groupName}</h5>
                                <small class="text-muted">${group.count} Tugas</small>
                            </div>
                            <div class="ml-auto">
                                <div class="mini-progress-circle" style="position:relative; width:40px; height:40px; border-radius:50%; background: conic-gradient(${chartColor} ${avg}%, #eee 0); display:flex; align-items:center; justify-content:center;">
                                    <div style="position:absolute; width:32px; height:32px; background:white; border-radius:50%;"></div>
                                    <span style="position:relative; z-index:1; font-size:0.8rem; font-weight:bold;">${avg}%</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            }
        }
        renderTaskGroups();

        // Toggle Slide (Reveal Checkmark)
        function toggleSlide(taskId) {
            // Don't slide completed tasks
            const task = tasks.find(t => t.id === taskId);
            if (task && task.status === 'done') return;
            
            const container = document.getElementById(`task-container-${taskId}`);
            if (container) {
                container.classList.toggle('revealed');
            }
        }

        // Complete Task (Click Checkmark)
        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const container = document.getElementById(`task-container-${taskId}`);
            
            // Mark as done
            task.status = 'done';
            task.progress = 100;
            
            // Slide back
            if(container) {
                container.classList.remove('revealed');
            }
            
            // Save to storage
            saveTask(task);
            
            // Re-render all components that depend on task data
            renderProgressOverview();
            renderTaskGroups();
            renderTasks(document.querySelector('.filter-btn.active').innerText);
        }

        // Helper: Get Task Category
        function getTaskCategory(task) {
            if (task.status === 'done') return 'Selesai';
            
            const now = new Date();
            const end = new Date(task.end);
            const diffTime = end - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (diffDays <= 3) return 'On Progress';
            return 'Todo';
        }

        // Render Tasks List (Bottom)
        function renderTasks(filter = 'Semua') {
            // Update active button state
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const btnText = btn.innerText;
                const filterMatch = (filter === 'On Progress' && btnText === 'On Progres') || (btnText === filter);
                
                if(filterMatch) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const taskListEl = document.getElementById('taskList');
            let filteredTasks = tasks;

            if (filter === 'Todo') {
                filteredTasks = tasks.filter(t => getTaskCategory(t) === 'Todo');
            } else if (filter === 'On Progress') {
                filteredTasks = tasks.filter(t => getTaskCategory(t) === 'On Progress');
            } else if (filter === 'Selesai') {
                filteredTasks = tasks.filter(t => getTaskCategory(t) === 'Selesai');
            }

            if (filteredTasks.length === 0) {
                taskListEl.innerHTML = '<p class="text-muted">Tidak ada tugas untuk kategori ini.</p>';
            } else {
                taskListEl.innerHTML = filteredTasks.map(task => {
                    const category = getTaskCategory(task);
                    let statusClass = 'status-todo';
                    if (category === 'On Progress') { statusClass = 'status-progress'; }
                    if (category === 'Selesai') { statusClass = 'status-done'; }
                    
                    const group = task.group || 'General';
                    const groupIcon = 'üëú';

                    const date = new Date(task.end);
                    const formattedDate = `${date.getDate()}/${date.toLocaleString('id-ID', { month: 'short' })}/${String(date.getFullYear()).slice(-2)}`;
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    const isDone = task.status === 'done';
                    const completedClass = isDone ? 'completed' : '';

                    return `
                    <div class="task-item-container ${completedClass}" id="task-container-${task.id}">
                        <div class="task-card-content" onclick="toggleSlide('${task.id}')">
                            <div class="new-task-card">
                                <div class="new-task-header">
                                    <span class="new-task-group">${group}</span>
                                    <div class="card-icon" style="background-color: var(--${group.toLowerCase()}-bg, #ffe0e0);">${groupIcon}</div>
                                </div>
                                <h4 class="new-task-title">
                                    <span class="task-title-link" onclick="event.stopPropagation(); window.location.href='task/detailtask.html?id=${task.id}'">${task.name}</span>
                                </h4>
                                <div class="new-task-footer">
                                    <div class="new-task-meta">
                                        <span>üïí ${formattedTime}</span>
                                        <span>${formattedDate}</span>
                                    </div>
                                    <span class="new-task-status ${statusClass}" id="status-text-${task.id}">${category}</span>
                                </div>
                            </div>
                        </div>
                        <div class="task-complete-indicator" onclick="completeTask('${task.id}')">
                            ‚úì
                        </div>
                    </div>
                    `;
                }).join('');
            }
        }
        
        // Initial Render
        renderTasks('Semua');        // Render Schedules
        function renderSchedules() {
            const allSchedules = getSchedules();
            const scheduleListEl = document.getElementById('scheduleList');
            
            const filteredSchedules = allSchedules.filter(s => {
                const sDate = new Date(s.start);
                return (
                    sDate.getDate() === selectedDate.getDate() &&
                    sDate.getMonth() === selectedDate.getMonth() &&
                    sDate.getFullYear() === selectedDate.getFullYear()
                );
            });

            if (filteredSchedules.length === 0) {
                scheduleListEl.innerHTML = '<p class="text-muted">Tidak ada jadwal untuk tanggal ini.</p>';
            } else {
                scheduleListEl.innerHTML = filteredSchedules.map(schedule => `
                    <div class="schedule-item" onclick="window.location.href='schedule/detailschedule.html?id=${schedule.id}'">
                        <div class="schedule-time">
                            ${new Date(schedule.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            <br>
                            <span style="color:#ccc; font-weight:normal;">- ${new Date(schedule.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="schedule-info flex-grow">
                            <h5>${schedule.name}</h5>
                            <p>${schedule.location || 'No Location'}</p>
                        </div>
                        <div style="color:#4facfe;">üîî</div>
                    </div>
                `).join('');
            }
        }
        renderSchedules();
    </script>
</body>
</html>
